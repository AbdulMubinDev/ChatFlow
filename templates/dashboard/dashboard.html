{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ room.name }} - ChatFlow</title>
    <link rel="stylesheet" href="{% static 'css/dashboard/dashboard.css' %}" />
  </head>
  <body>
    <div
      class="dashboard-container"
      id="chatRoomApp"
      data-room-code="{{ room.code }}"
      data-room-url="{{ room_url }}"
      data-user-name="{{ request.user.get_full_name|default:request.user.username }}"
      data-user-handle="{{ request.user.username }}"
    >
      <!-- Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <h1 class="sidebar-brand">ChatFlow</h1>
          <button class="sidebar-toggle" id="sidebarToggle">
            <span></span>
            <span></span>
            <span></span>
          </button>
        </div>

        <div class="user-profile">
          <div class="user-avatar">
            <img
              src="{% static 'images/default-avatar.svg' %}"
              alt="User Avatar"
              id="userAvatar"
            />
            <span class="status-indicator online"></span>
          </div>
          <div class="user-info">
            <h3>{{ request.user.get_full_name|default:request.user.username }}</h3>
            <p>@{{ request.user.username }}</p>
          </div>
        </div>

        <nav class="sidebar-nav">
          <div class="room-meta-group">
            <p class="meta-label">Room</p>
            <h2>{{ room.name }}</h2>
            <p class="meta-value">Room ID: {{ room.code }}</p>
            <p class="meta-hint">
              Share <strong>{{ room.code }}</strong> plus the password to invite friends.
            </p>
            <button class="ghost-btn copy-btn" data-copy="{{ room_url }}" data-label="Copy invite link">
              Copy invite link
            </button>
            <a class="text-link" href="{% url 'dashboard' %}">â† Back to rooms</a>
          </div>
        </nav>

        <div class="sidebar-footer">
          <a href="{% url 'logout' %}" class="logout-btn">
            <span class="nav-icon">ğŸšª</span>
            <span class="nav-text">Logout</span>
          </a>
        </div>
      </aside>

      <!-- Chat List / Members -->
      <div class="chat-list" id="chatList">
        <div class="chat-list-header">
          <h2>Room members</h2>
          <p class="members-count">{{ participants|length }} active</p>
        </div>

        <div class="chat-items" id="memberList">
          {% for participant in participants %}
          <div class="chat-item {% if participant.id == request.user.id %}active{% endif %}">
            <div class="chat-avatar">
              <img src="{% static 'images/default-avatar.svg' %}" alt="{{ participant.username }}" />
              <span class="status-dot online"></span>
            </div>
            <div class="chat-info">
              <div class="chat-header">
                <h4>{{ participant.get_full_name|default:participant.username }}</h4>
                {% if participant.id == room.owner_id %}
                <span class="badge">Host</span>
                {% endif %}
              </div>
              <div class="chat-preview">
                <p>@{{ participant.username }}</p>
              </div>
            </div>
          </div>
          {% empty %}
          <p class="empty-members">No one is here yet.</p>
          {% endfor %}
        </div>
      </div>

      <!-- Chat Window -->
      <div class="chat-window" id="chatWindow">
        <div class="chat-window-header">
          <div class="chat-user-info">
            <div class="chat-user-avatar">
              <img src="{% static 'images/default-avatar.svg' %}" alt="Room" />
              <span class="status-dot online"></span>
            </div>
            <div class="chat-user-details">
              <h3>{{ room.name }}</h3>
              <span class="user-status">Secure room â€¢ {{ room.code }}</span>
            </div>
          </div>
          <div class="chat-actions">
            <button class="ghost-btn copy-btn" data-copy="{{ room.code }}" data-label="Copy room ID">Copy room ID</button>
            <button class="action-btn mobile-back" id="mobileBack">â†</button>
          </div>
        </div>

        <div class="chat-messages" id="chatMessages">
          {% if room_messages %}
          {% regroup room_messages by created_at.date as date_list %}
          {% for date_group in date_list %}
          <div class="message-date">
            <span>{{ date_group.grouper|date:"M d, Y" }}</span>
          </div>
          {% for message in date_group.list %}
          <div class="message {% if message.sender_id == request.user.id %}sent{% else %}received{% endif %}">
            {% if message.sender_id != request.user.id %}
            <div class="message-avatar">
              <img src="{% static 'images/default-avatar.svg' %}" alt="{{ message.sender.username }}" />
            </div>
            {% endif %}
            <div class="message-content">
              <div class="message-bubble">
                <p>
                  <strong>{{ message.sender.get_full_name|default:message.sender.username }}:</strong>
                  {{ message.content }}
                </p>
              </div>
              <span class="message-time">{{ message.created_at|time:"H:i" }}</span>
            </div>
          </div>
          {% endfor %}
          {% endfor %}
          {% else %}
          <div class="message-date">
            <span>Start chatting</span>
          </div>
          {% endif %}
          <div class="typing-indicator" id="typingIndicator" style="display: none">
            <div class="message-avatar">
              <img src="{% static 'images/default-avatar.svg' %}" alt="Typing" />
            </div>
            <div class="typing-dots">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        </div>

        <div class="chat-input-container">
          <form class="chat-input-form" id="messageForm">
            <input
              type="text"
              placeholder="Type a message..."
              id="messageInput"
              autocomplete="off"
            />
            <button type="submit" class="send-btn" id="sendBtn">
              <span class="send-icon">â¤</span>
            </button>
          </form>
        </div>
      </div>
    </div>

    <script src="{% static 'js/dashboard/dashboard.js' %}"></script>
  </body>
</html>

